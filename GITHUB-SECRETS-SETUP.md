# GitHub Secrets Setup Guide

## Issue: Permission Denied (publickey)

If you see this error in GitHub Actions:
```
ubuntu@13.200.242.176: Permission denied (publickey).
Error: Process completed with exit code 255.
```

This means the `EC2_PRIVATE_KEY` GitHub secret is either:
- Not configured
- Incorrectly formatted
- Missing newlines

## Required GitHub Secrets

Your repository needs these three secrets:

### 1. AWS_ACCESS_KEY_ID
Your AWS access key for API access.

### 2. AWS_SECRET_ACCESS_KEY
Your AWS secret access key.

### 3. EC2_PRIVATE_KEY
The SSH private key to access EC2 instances (generated by Terraform).

## How to Get the Secrets

### Option 1: Use the PowerShell Script (Recommended)

```powershell
cd terraform-crud
.\scripts\get-secrets.ps1
```

This will:
- Extract the EC2 private key from Terraform
- Display all secrets in the correct format
- Copy the EC2_HOST to your clipboard

### Option 2: Manual Extraction

```powershell
cd terraform-crud/terraform

# Get the private key
Get-Content ..\.ssh\crud-app-key

# Or on Linux/Mac
cat ../.ssh/crud-app-key
```

## Adding Secrets to GitHub

### Step 1: Go to Repository Settings

Navigate to:
```
https://github.com/YOUR_USERNAME/terraform-crud/settings/secrets/actions
```

Or:
1. Go to your repository on GitHub
2. Click **Settings** tab
3. Click **Secrets and variables** → **Actions**
4. Click **New repository secret**

### Step 2: Add AWS_ACCESS_KEY_ID

- **Name:** `AWS_ACCESS_KEY_ID`
- **Value:** Your AWS access key (e.g., `AKIAIOSFODNN7EXAMPLE`)

Click **Add secret**

### Step 3: Add AWS_SECRET_ACCESS_KEY

- **Name:** `AWS_SECRET_ACCESS_KEY`
- **Value:** Your AWS secret key (e.g., `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`)

Click **Add secret**

### Step 4: Add EC2_PRIVATE_KEY

⚠️ **IMPORTANT:** This is the most common source of errors!

- **Name:** `EC2_PRIVATE_KEY`
- **Value:** The **entire** private key including headers

**Correct Format:**
```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAACFwAAAAdzc2gtcn
NhAAAAAwEAAQAAAgEAt/DPC63yyZxSq5nHSsU8CFVEJPABawrB/SKVamdp1wPJX2dZrjlM
r2TB3AxshYmhA3r9kEvaNTihLxm5bdn8maIhM6eeVuA3MrnkIGFhXf57qmgJKm7RJHviI6
... (many more lines) ...
5mnuFARo28o5QwAAAA9yb290QGlwLTE3Mi0zMS0xNQECAw==
-----END OPENSSH PRIVATE KEY-----
```

**Key Points:**
- ✅ Include `-----BEGIN OPENSSH PRIVATE KEY-----`
- ✅ Include `-----END OPENSSH PRIVATE KEY-----`
- ✅ Include ALL lines in between
- ✅ Preserve all newlines
- ❌ Don't add extra spaces or characters
- ❌ Don't remove any lines

### How to Copy the Private Key Correctly

**Windows PowerShell:**
```powershell
Get-Content terraform-crud\.ssh\crud-app-key | Set-Clipboard
```
Then paste directly into GitHub.

**Linux/Mac:**
```bash
cat terraform-crud/.ssh/crud-app-key | pbcopy  # Mac
cat terraform-crud/.ssh/crud-app-key | xclip   # Linux
```

**Manual Copy:**
1. Open the file in a text editor (Notepad, VS Code, etc.)
2. Select ALL content (Ctrl+A)
3. Copy (Ctrl+C)
4. Paste into GitHub secret field (Ctrl+V)

## Verification

After adding all secrets, verify they exist:

1. Go to: `https://github.com/YOUR_USERNAME/terraform-crud/settings/secrets/actions`
2. You should see three secrets:
   - `AWS_ACCESS_KEY_ID`
   - `AWS_SECRET_ACCESS_KEY`
   - `EC2_PRIVATE_KEY`

## Testing the Setup

### Option 1: Re-run Failed Workflow

1. Go to: `https://github.com/YOUR_USERNAME/terraform-crud/actions`
2. Click on the failed workflow run
3. Click **Re-run all jobs**

### Option 2: Push a New Commit

```powershell
git add .
git commit -m "Test deployment with secrets"
git push origin main
```

## Troubleshooting

### Error: "Permission denied (publickey)"

**Cause:** EC2_PRIVATE_KEY is missing or incorrect

**Solution:**
1. Verify the secret exists in GitHub
2. Re-copy the private key ensuring all lines are included
3. Make sure you're copying from `.ssh/crud-app-key` (NOT `.pub`)

### Error: "Load key: invalid format"

**Cause:** Private key has incorrect format or extra characters

**Solution:**
1. Delete the existing `EC2_PRIVATE_KEY` secret
2. Re-copy the key using the methods above
3. Ensure no extra spaces or newlines at the beginning/end

### Error: "Host key verification failed"

**Cause:** SSH host key not in known_hosts (rare, workflow handles this)

**Solution:** The workflow automatically adds hosts with `ssh-keyscan`

### Private Key File Not Found

If `.ssh/crud-app-key` doesn't exist:

```powershell
cd terraform-crud/terraform
terraform output private_key_path
```

This will show you where Terraform saved the key.

## Security Best Practices

### 1. Never Commit Private Keys
The `.ssh/` directory is in `.gitignore` - keep it that way!

### 2. Rotate Keys Regularly
Regenerate keys periodically:
```powershell
cd terraform-crud/terraform
terraform taint tls_private_key.ssh
terraform apply
```

### 3. Use IAM Roles (Advanced)
For production, consider using AWS IAM roles instead of access keys.

### 4. Limit Secret Access
Only give repository access to people who need it.

## Quick Reference

### Get All Secrets at Once

```powershell
# Run this from terraform-crud directory
.\scripts\get-secrets.ps1
```

### Verify Terraform State

```powershell
cd terraform-crud/terraform
terraform output
```

Should show:
- `ec2_public_ip`
- `private_key_path`
- `alb_dns`
- `dynamodb_table_name`

### Check EC2 Key Pair in AWS

```powershell
aws ec2 describe-key-pairs --key-names crud-app-key --region ap-south-1
```

Should return the key pair details.

## Common Mistakes

❌ **Copying the public key instead of private key**
- Public key: `.ssh/crud-app-key.pub` (wrong!)
- Private key: `.ssh/crud-app-key` (correct!)

❌ **Missing the BEGIN/END lines**
- Must include `-----BEGIN OPENSSH PRIVATE KEY-----`
- Must include `-----END OPENSSH PRIVATE KEY-----`

❌ **Adding extra newlines**
- Copy exactly as-is from the file
- No extra blank lines at start or end

❌ **Wrong region**
- Ensure your AWS credentials have access to `ap-south-1`

## Need Help?

If you're still having issues:

1. Check the GitHub Actions logs for specific error messages
2. Verify all three secrets are configured
3. Ensure Terraform infrastructure is deployed
4. Confirm you're using the correct AWS region (ap-south-1)

## Summary

✅ **Three secrets required:** AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, EC2_PRIVATE_KEY  
✅ **Get secrets:** Run `.\scripts\get-secrets.ps1`  
✅ **Add to GitHub:** Settings → Secrets and variables → Actions  
✅ **Test:** Re-run workflow or push new commit  

The most common issue is the EC2_PRIVATE_KEY format - make sure to copy the entire key including headers!
